#include<stdio.h>
#include<stdlib.h>
#include<float.h>
#include<string.h>
#include<assert.h>

/*Definições desenvolvedor usuario*/
typedef struct _reg{
    float emb[128]; //Modicacao de estrutura para vetor de 128 floats
    char id[100]; //Modificacao de estrutura para vetor de 100 caracteres
}treg;

void * aloca_reg(float emb[], char id[]){
    treg * reg;

    reg = malloc(sizeof(treg));
    memcpy(reg->emb, emb, 128*sizeof(float)); //Alocar o vetor do embedding
    strcpy(reg->id,id); //Alocar o vetor do id

    return reg;
}

int comparador(void *a, void *b, int pos){

    treg *faceA = (treg *) a; //Casting para acessar o embedding de a
    treg *faceB = (treg *) b; //Casting para acessar o embedding de b

    if ((faceA->emb[pos] - faceB->emb[pos]) < 0) //Verifica se a diferenca entre essas posicoes de embeddings e negativa
        return -1;
    else return 1;
}

double distancia(void * a, void *b){
        
        double distancia = 0;
        double aux;

        treg *faceA = (treg *) a; //Casting para acessar embedding de a
        treg *faceB = (treg *) b; //Casting para acessar embedding de b
        
        for (int i = 0; i < 128; i++) {
            aux = faceA->emb[i] - faceB->emb[i];
            distancia +=  aux * aux;
        }

        return distancia;
}


/*Definições desenvolvedor da biblioteca*/

typedef struct _node{
    void * key;
    struct _node * esq;
    struct _node * dir;
}tnode;

typedef struct _arv{
    tnode * raiz;
    int (*cmp)(void *, void *, int);
    double (*dist) (void *, void *);
    int k;
}tarv;



/*funções desenvolvedor da biblioteca*/

void kdtree_constroi(tarv * arv, int (*cmp)(void *a, void *b, int ),double (*dist) (void *, void *),int k){
    arv->raiz = NULL;
    arv->cmp = cmp;
    arv->dist = dist;
    arv->k = k;
}


void _kdtree_insere(tnode **raiz, void * key, int (*cmp)(void *a, void *b, int),int profund, int k){
    if(*raiz == NULL){
        *raiz = malloc(sizeof(tnode));
        (*raiz)->key = key;
        (*raiz)->esq = NULL;
        (*raiz)->dir = NULL;
    }else{
        int pos = profund % k;
        if (cmp( (*(*raiz)).key , key ,pos) <0){
            _kdtree_insere( &((*(*raiz)).dir),key,cmp,profund + 1,k);
        }else{
            _kdtree_insere( &((*raiz)->esq),key,cmp,profund +1,k);
        }
    }
}


void kdtree_insere(tarv *arv, void *key){
    _kdtree_insere(&(arv->raiz),key,arv->cmp,0,arv->k);
}


void _kdtree_destroi(tnode * node){
    if (node!=NULL){
        _kdtree_destroi(node->esq);
        _kdtree_destroi(node->dir);
        free(node->key);
        free(node);
    }
}

void kdtree_destroi(tarv *arv){
    _kdtree_destroi(arv->raiz);
}

void _kdtree_busca(tarv *arv, tnode ** atual, void * key, int profund, double *menor_dist, tnode **menor){
    tnode ** lado_principal; 
    tnode ** lado_oposto;    
    if (*atual != NULL){
        double dist_atual = arv->dist((*atual)->key, key);
        if (dist_atual < *menor_dist){
            *menor_dist = dist_atual;
            *menor = *atual;
        }
        int pos = profund % arv->k;
        int comp = arv->cmp(key, (*atual)->key, pos);

        printf("%s dist %4.3f menor_dist %4.3f comp %d\n", ((treg *)((tnode *)*atual)->key)->id,dist_atual,*menor_dist,comp); //Mudanca parra identificar por id

        /* define lado principal para buscar */
        if (comp < 0){
            lado_principal =  &((*atual)->esq);
            lado_oposto    =  &((*atual)->dir); 
        }else{
            lado_principal =  &((*atual)->dir);
            lado_oposto    =  &((*atual)->esq); 
        }

        _kdtree_busca(arv, lado_principal, key, profund + 1, menor_dist, menor);

        /* Verifica se deve buscar também no outro lado*/

        if (comp*comp < *menor_dist) {
            printf("tentando do outro lado %d\n",comp*comp); //Modificacao de tipo de argumento %f -> %d
            _kdtree_busca(arv, lado_oposto, key, profund + 1, menor_dist, menor);
        }
    }
}


tnode * kdtree_busca(tarv *arv, void * key){
    tnode * menor = NULL;
    double menor_dist = DBL_MAX;
    _kdtree_busca(arv,&(arv->raiz),key,0,&menor_dist,&menor);
    return menor;
}

treg buscar_mais_proximo(tarv *arv, treg query) {
    double menor_dist = 1e20;
    tnode *menor = NULL;
    _kdtree_busca(arv, &(arv->raiz), &query, 0, &menor_dist, &menor);
    return *((treg *)(menor->key));
}


tarv arvore_global;

tarv* get_tree() {
    return &arvore_global;
}

void inserir_face(treg p) { //Mudanca inserir_ponto->inserir_face
    treg *novo = malloc(sizeof(treg));
    *novo = p;  // cópia de estrutura
    kdtree_insere(&arvore_global,novo);
}
void kdtree_construir() {
    arvore_global.k = 128; //Mudanca na dimensao da arvore
    arvore_global.dist = distancia;
    arvore_global.cmp = comparador;
    arvore_global.raiz = NULL;
}

/*teste*/

void test_constroi(){
    /* declaracao de variaveis */
    tarv arv;
    tnode node1;
    tnode node2;

    float embedding1[] = {0.2980802655220032,-0.03360675275325775,0.3388718366622925, -1.7413562536239624,-0.784349262714386,0.3835407793521881,1.1973789930343628,2.09960675239563,-1.310384750366211,1.467043161392212,-0.7045886516571045,0.6474849581718445,0.4072667360305786,0.4841907322406769,1.194253921508789,1.926926851272583,-0.46917733550071716,-1.3932956457138062,-0.1221161037683487,-1.1876466274261475,-0.716303825378418,0.09898395091295242,0.029167823493480682,0.23844030499458313,0.011325591243803501,-1.1110047101974487,0.3890831470489502,0.6718171834945679,-1.5742504596710205,1.137557864189148,-1.3122276067733765,-2.0911238193511963,0.7618796825408936,0.4938300848007202,1.0169013738632202,0.21863612532615662,-1.1628775596618652,-0.52995765209198,0.820045530796051,-0.5417426824569702,-1.3963302373886108,-0.023524465039372444,-1.7191153764724731,-0.690735936164856,-0.32364726066589355,-1.2630215883255005,-0.9787782430648804,0.9369034767150879,-0.20637862384319305,0.12987154722213745,-1.1705992221832275,1.3327066898345947,0.5326818227767944,-1.311637282371521,1.6792702674865723,-0.613252580165863,-0.44220659136772156,0.7002156972885132,0.8317900896072388,-1.0074819326400757,-1.356228232383728,-0.23342493176460266,1.1754733324050903,0.2419045865535736,1.4076836109161377,-0.22201208770275116,-2.328334331512451,1.4789693355560303,-0.6507938504219055,1.5151606798171997,1.2581294775009155,1.0749934911727905,-0.16889168322086334,-0.3382827937602997,-0.11271443963050842,0.00517311692237854,-1.5070527791976929,0.4800650179386139,1.3583989143371582,1.0664308071136475,-0.7968704700469971,-0.46674689650535583,-1.057376742362976,0.16527783870697021,2.9905734062194824,-1.092280626296997,-0.7108088731765747,-0.6593044996261597,-1.6570568084716797,0.24225075542926788,1.129462480545044, 0.7919299006462097,0.08551745116710663, 1.5065007209777832, -0.9458757638931274, 0.0016025288496166468, -0.20012807846069336, 1.4880638122558594, -0.6376892328262329, 0.732830822467804, 0.3825101852416992, 0.13904502987861633, -0.4807364344596863, 0.83270663022995, -2.3021788597106934, 0.22049948573112488, -1.3139621019363403, -1.3354709148406982, -2.0551841259002686, 2.0243406295776367, 0.6596667170524597, 0.6125975251197815, 1.2044768333435059, -0.33054107427597046, 0.8968545198440552, 0.198095440864563, 1.6695961952209473, -0.3560256361961365, 0.7725057601928711, 0.5590473413467407, 2.347428798675537, 0.6419394016265869, -0.7977674603462219, -1.2269319295883179, -1.5555140972137451, -0.27337655425071716, -0.008312751539051533, -0.5588859915733337};
    float embedding2[] = {-0.3444824516773224,0.3957308530807495,1.1916395425796509,-0.5949933528900146,-0.06057170033454895,-0.2755972146987915,0.6691650152206421,0.78949373960495,1.199083924293518,1.5521435737609863,-1.787296175956726,0.1690875142812729,-1.1313554048538208,0.6233354806900024,-0.8923656940460205,-0.8250806927680969,-1.9628963470458984,-0.9626147747039795,-1.3179712295532227,-1.1844661235809326,0.7339369058609009,-1.074603796005249,-0.915801465511322,-0.8999994993209839,-2.680684804916382,0.8732487559318542,-0.6657688617706299,-0.6124828457832336,0.04938749223947525,1.042906641960144,0.27802640199661255,0.63856041431427,0.47814053297042847,-1.9650886058807373,1.220073938369751,-0.969035804271698,-2.018221139907837,0.640932023525238,0.7077299952507019,0.8216730356216431,-0.6868153810501099,0.32834339141845703,-0.3908195197582245,0.10912209749221802,-0.3966069221496582,-0.2523846924304962,-0.5121811628341675,1.7615693807601929,-1.123538613319397,-0.06918759644031525,1.6276580095291138,1.7832202911376953,0.21234163641929626,-1.2876864671707153,1.0771729946136475,-0.5904300212860107,-0.42133599519729614,-0.49832862615585327,-0.575025200843811,1.518068790435791,0.1255861222743988,-0.17974816262722015,-3.0156195163726807,-0.7997176647186279,0.5721785426139832,-0.2930648922920227,-1.068603754043579,1.684072732925415,0.8004893660545349,0.10932427644729614,-0.47739702463150024,-0.2639109194278717,1.1439850330352783,-1.498402714729309,1.5997024774551392,0.9678308963775635,-0.42338722944259644,-0.44528138637542725,-0.6675369143486023,-1.591376543045044,0.5033718943595886,-0.33471179008483887,0.6122221946716309,-1.830485463142395,-1.9930661916732788,-1.024031162261963,-1.019924521446228,-0.5520651340484619,1.4305510520935059,0.190659299492836,-2.0403659343719482,1.1248588562011719,-0.14571087062358856,0.030190741643309593,1.0649715662002563,1.742930293083191,-1.176995873451233,1.1136448383331299,0.17300260066986084,-0.5261322259902954,1.445635437965393,-0.04272829741239548,-3.1843690872192383,-1.400330901145935,0.026010915637016296,-1.8383736610412598,1.393062949180603,0.11060348153114319,1.440458059310913,0.5884268283843994,0.24727804958820343,0.024794183671474457,-1.691043496131897,-0.6011244654655457,-1.011088252067566,1.9053137302398682,0.24062293767929077,-0.113981693983078,-1.136901617050171,-0.2654804289340973,0.6875818967819214,-1.221598744392395,-1.4060215950012207,-0.2692178189754486,0.06177660450339317,-0.08551202714443207,-0.790888249874115,-0.0527612641453743};
    node1.key = aloca_reg(embedding1, "Amanda");
    node2.key = aloca_reg(embedding2, "Takashi");


    /* chamada de funções */
    kdtree_constroi(&arv,comparador,distancia,128);
    
    /* testes */
    assert(arv.raiz == NULL);
    assert(arv.k == 128);
    assert(arv.cmp(node1.key,node2.key,0) == 1);
    assert(arv.cmp(node1.key,node2.key,1) == -1);
    assert(strcpy(((treg *)node1.key)->id,"Amanda"));
    assert(strcpy(((treg *)node2.key)->id,"Takashi"));
    
    free(node1.key);
    free(node2.key);
}

void test_busca(){
    tarv arv;
    kdtree_constroi(&arv,comparador,distancia,128);

    float embedding1[] = {0.2980802655220032,-0.03360675275325775,0.3388718366622925, -1.7413562536239624,-0.784349262714386,0.3835407793521881,1.1973789930343628,2.09960675239563,-1.310384750366211,1.467043161392212,-0.7045886516571045,0.6474849581718445,0.4072667360305786,0.4841907322406769,1.194253921508789,1.926926851272583,-0.46917733550071716,-1.3932956457138062,-0.1221161037683487,-1.1876466274261475,-0.716303825378418,0.09898395091295242,0.029167823493480682,0.23844030499458313,0.011325591243803501,-1.1110047101974487,0.3890831470489502,0.6718171834945679,-1.5742504596710205,1.137557864189148,-1.3122276067733765,-2.0911238193511963,0.7618796825408936,0.4938300848007202,1.0169013738632202,0.21863612532615662,-1.1628775596618652,-0.52995765209198,0.820045530796051,-0.5417426824569702,-1.3963302373886108,-0.023524465039372444,-1.7191153764724731,-0.690735936164856,-0.32364726066589355,-1.2630215883255005,-0.9787782430648804,0.9369034767150879,-0.20637862384319305,0.12987154722213745,-1.1705992221832275,1.3327066898345947,0.5326818227767944,-1.311637282371521,1.6792702674865723,-0.613252580165863,-0.44220659136772156,0.7002156972885132,0.8317900896072388,-1.0074819326400757,-1.356228232383728,-0.23342493176460266,1.1754733324050903,0.2419045865535736,1.4076836109161377,-0.22201208770275116,-2.328334331512451,1.4789693355560303,-0.6507938504219055,1.5151606798171997,1.2581294775009155,1.0749934911727905,-0.16889168322086334,-0.3382827937602997,-0.11271443963050842,0.00517311692237854,-1.5070527791976929,0.4800650179386139,1.3583989143371582,1.0664308071136475,-0.7968704700469971,-0.46674689650535583,-1.057376742362976,0.16527783870697021,2.9905734062194824,-1.092280626296997,-0.7108088731765747,-0.6593044996261597,-1.6570568084716797,0.24225075542926788,1.129462480545044, 0.7919299006462097,0.08551745116710663, 1.5065007209777832, -0.9458757638931274, 0.0016025288496166468, -0.20012807846069336, 1.4880638122558594, -0.6376892328262329, 0.732830822467804, 0.3825101852416992, 0.13904502987861633, -0.4807364344596863, 0.83270663022995, -2.3021788597106934, 0.22049948573112488, -1.3139621019363403, -1.3354709148406982, -2.0551841259002686, 2.0243406295776367, 0.6596667170524597, 0.6125975251197815, 1.2044768333435059, -0.33054107427597046, 0.8968545198440552, 0.198095440864563, 1.6695961952209473, -0.3560256361961365, 0.7725057601928711, 0.5590473413467407, 2.347428798675537, 0.6419394016265869, -0.7977674603462219, -1.2269319295883179, -1.5555140972137451, -0.27337655425071716, -0.008312751539051533, -0.5588859915733337};
    float embedding2[] = {-0.3444824516773224,0.3957308530807495,1.1916395425796509,-0.5949933528900146,-0.06057170033454895,-0.2755972146987915,0.6691650152206421,0.78949373960495,1.199083924293518,1.5521435737609863,-1.787296175956726,0.1690875142812729,-1.1313554048538208,0.6233354806900024,-0.8923656940460205,-0.8250806927680969,-1.9628963470458984,-0.9626147747039795,-1.3179712295532227,-1.1844661235809326,0.7339369058609009,-1.074603796005249,-0.915801465511322,-0.8999994993209839,-2.680684804916382,0.8732487559318542,-0.6657688617706299,-0.6124828457832336,0.04938749223947525,1.042906641960144,0.27802640199661255,0.63856041431427,0.47814053297042847,-1.9650886058807373,1.220073938369751,-0.969035804271698,-2.018221139907837,0.640932023525238,0.7077299952507019,0.8216730356216431,-0.6868153810501099,0.32834339141845703,-0.3908195197582245,0.10912209749221802,-0.3966069221496582,-0.2523846924304962,-0.5121811628341675,1.7615693807601929,-1.123538613319397,-0.06918759644031525,1.6276580095291138,1.7832202911376953,0.21234163641929626,-1.2876864671707153,1.0771729946136475,-0.5904300212860107,-0.42133599519729614,-0.49832862615585327,-0.575025200843811,1.518068790435791,0.1255861222743988,-0.17974816262722015,-3.0156195163726807,-0.7997176647186279,0.5721785426139832,-0.2930648922920227,-1.068603754043579,1.684072732925415,0.8004893660545349,0.10932427644729614,-0.47739702463150024,-0.2639109194278717,1.1439850330352783,-1.498402714729309,1.5997024774551392,0.9678308963775635,-0.42338722944259644,-0.44528138637542725,-0.6675369143486023,-1.591376543045044,0.5033718943595886,-0.33471179008483887,0.6122221946716309,-1.830485463142395,-1.9930661916732788,-1.024031162261963,-1.019924521446228,-0.5520651340484619,1.4305510520935059,0.190659299492836,-2.0403659343719482,1.1248588562011719,-0.14571087062358856,0.030190741643309593,1.0649715662002563,1.742930293083191,-1.176995873451233,1.1136448383331299,0.17300260066986084,-0.5261322259902954,1.445635437965393,-0.04272829741239548,-3.1843690872192383,-1.400330901145935,0.026010915637016296,-1.8383736610412598,1.393062949180603,0.11060348153114319,1.440458059310913,0.5884268283843994,0.24727804958820343,0.024794183671474457,-1.691043496131897,-0.6011244654655457,-1.011088252067566,1.9053137302398682,0.24062293767929077,-0.113981693983078,-1.136901617050171,-0.2654804289340973,0.6875818967819214,-1.221598744392395,-1.4060215950012207,-0.2692178189754486,0.06177660450339317,-0.08551202714443207,-0.790888249874115,-0.0527612641453743};
    float embedding3[] = {-1.4672935009002686, -0.6838959455490112, 0.32935377955436707, -0.9098999500274658, 0.9775353074073792, 0.15936538577079773, 1.187646508216858, -1.674432396888733, 0.25757551193237305, 0.7665404677391052, -0.5433919429779053, 1.2113326787948608, 0.5734163522720337, -0.06523992866277695, 1.6856417655944824, -0.32572364807128906, 1.2796472311019897, -1.3771867752075195, -1.0707353353500366, -1.1291334629058838, -1.288966417312622, -0.5358791351318359, -2.1643857955932617, -0.9099979400634766, -0.8717183470726013, 0.22198736667633057, 1.2363033294677734, -0.8831321001052856, 0.48179036378860474, 2.3898212909698486, 0.6502104997634888, -2.3415603637695312, -0.6542994976043701, -0.6478356122970581, 1.7437564134597778, 0.6231780052185059, 0.2082872986793518, 0.775602400302887, -0.18330013751983643, 0.5053437948226929, 2.264047384262085, -0.29376843571662903, -0.22888118028640747, 2.172902822494507, -0.6134936213493347, -2.417043447494507, 0.0395517461001873, -0.6805235147476196, -0.23366256058216095, -1.0131275653839111, -0.22210808098316193, 0.3278753459453583, 0.5789491534233093, -1.1835665702819824, -0.3142887055873871, -1.6302096843719482, 1.1920524835586548, 0.7917251586914062, -0.2001815140247345, -1.887332797050476, -0.16792407631874084, -1.4310386180877686, -0.365018755197525, -0.4886877238750458, -0.8172217607498169, 1.0137734413146973, -0.9427860975265503, -1.0640381574630737, -0.47532007098197937, -0.7562315464019775, 1.560868740081787, -0.1023760735988617, 0.7836039066314697, -1.5406757593154907, 0.14050690829753876, 0.24687474966049194, 1.2934492826461792, 0.29870691895484924, 0.8009961247444153, 0.16373471915721893, -2.0363497734069824, 1.5213329792022705, -0.054038479924201965, -0.29478228092193604, -1.9008055925369263, 0.4943031966686249, 0.5935813188552856, 0.11581236124038696, 0.44880834221839905, 1.476321816444397, -1.9903546571731567, -0.470621258020401, 0.045014943927526474, 0.6162698864936829, 0.7434823513031006, 0.13840734958648682, 0.8715665340423584, 0.17682020366191864, 0.43131521344184875, 1.3685901165008545, 1.6998193264007568, 1.1252321004867554, -1.0962679386138916, 1.6224400997161865, 0.5873463749885559, 1.4676920175552368, 0.22371989488601685, -1.3138571977615356, 1.279747724533081, 0.0147778932005167, 0.23961682617664337, 0.8051973581314087, 1.9375718832015991, -0.2803148627281189, -0.5045331716537476, -0.9428653717041016, -0.5331131219863892, 0.1750471442937851, 0.6011477112770081, -0.7068347930908203, 0.43393468856811523, 0.4839712679386139, -0.1098959892988205, -2.1129941940307617, -1.7081406116485596, 3.039199113845825, 1.1478395462036133, -0.9277768731117249};
    float embedding4[] = {0.0863126590847969, -1.415789008140564, 0.18776723742485046, -1.6782275438308716, 1.6425645351409912, -0.6560758948326111, -0.18873560428619385, 1.3744844198226929, -1.4732452630996704, -0.5942886471748352, -2.4521772861480713, 0.3739129304885864, 1.7200753688812256, 0.45504751801490784, 0.7545595169067383, -0.08688394725322723, 0.6924809217453003, -0.6249821186065674, 0.5285797119140625, -0.7223597168922424, -0.4408217668533325, 0.20972125232219696, -0.40233245491981506, 1.4374786615371704, -0.6613671183586121, -1.6220672130584717, 0.9041851758956909, 0.12647883594036102, -0.8000243306159973, -0.7093865275382996, 0.20786410570144653, -0.3306101858615875, 0.4521355628967285, 0.9616132974624634, -0.9551425576210022, 0.0469086579978466, 1.0484442710876465, -1.0267431735992432, 0.8182181119918823, 0.028690092265605927, 1.3543517589569092, 0.09277094155550003, 0.26723676919937134, -0.5109549760818481, -0.5668926239013672, -1.552037239074707, 0.2807932198047638, -1.7991032600402832, -0.4340406656265259, -0.5285738706588745, -4.077518463134766, 2.2922606468200684, -0.6640254259109497, -0.23450234532356262, 0.14883114397525787, 0.3857574164867401, -0.31372666358947754, -1.2058929204940796, -0.48662132024765015, 0.3426360785961151, 0.12690725922584534, -1.010918140411377, 1.0173076391220093, 1.2133389711380005, -1.7930351495742798, 1.3643951416015625, 1.0949426889419556, 1.1942166090011597, -0.9267063736915588, 1.3160501718521118, 0.7483993768692017, 1.5337470769882202, 0.5032216906547546, -1.30846107006073, 2.561020851135254, -0.5999831557273865, -1.685049295425415, -0.3908991515636444, -0.3406772017478943, -0.26936453580856323, -0.48590654134750366, 1.5187714099884033, -0.3362831473350525, 0.1854705512523651, 1.732424020767212, 1.8251087665557861, -1.3022562265396118, -1.0997871160507202, -0.41548430919647217, 1.1242179870605469, 0.09388965368270874, -0.6444543600082397, -1.4310599565505981, -0.9461016058921814, 0.42389488220214844, -0.3714161217212677, -1.5593668222427368, -0.5606202483177185, 0.787913978099823, 1.4662871360778809, 0.014730166643857956, 2.2146596908569336, -0.41280657052993774, -0.6497620344161987, 0.35172075033187866, 0.12214730679988861, -1.121848464012146, -0.9237567186355591, -1.9343615770339966, 0.4269251823425293, -1.541165828704834, 2.089552640914917, 1.0755081176757812, -0.9252298474311829, -0.7230034470558167, -1.0233399868011475, -1.5123618841171265, -0.08373923599720001, -0.7093164920806885, -0.7239874005317688, 1.1244088411331177, 0.10405578464269638, 1.4567848443984985, -1.7797386646270752, -0.5262166261672974, -0.8742400407791138, 1.1572200059890747, 0.7614173889160156};
    float embedding5[] = {-0.148542582988739, -0.444406658411026, -0.1261216104030609, -0.3189634084701538, 0.35836219787597656, 0.08578404039144516, 0.15999898314476013, -0.2915423512458801, 0.037262603640556335, 0.2129094898700714, 0.3077390789985657, -0.36021167039871216, 0.20143790543079376, -0.4246619641780853, 0.04290127754211426, 0.43410152196884155, 0.3962705433368683, -0.2852940559387207, 0.13057726621627808, -0.4350263476371765, 0.08222401142120361, 0.08453336358070374, -0.3337842524051666, -0.13032808899879456, 0.25314322113990784, -0.11103378981351852, 0.57026207447052, 0.29604068398475647, -0.24880386888980865, 0.08056121319532394, -0.069458968937397, 0.3538898825645447, 0.13324648141860962, -0.07445500046014786, 0.5653449892997742, -0.40862059593200684, 0.3000664710998535, 0.05408276990056038, 0.36561524868011475, 0.11640285700559616, 0.32777008414268494, 0.07390748709440231, -0.09541358053684235, -0.14075642824172974, -0.32467731833457947, -0.5518068075180054, 0.07503025233745575, -0.003560662269592285, 0.5313830971717834, 0.2509366273880005, -0.5514603853225708, 0.1634858250617981, 0.13915596902370453, -0.24332499504089355, 0.07336561381816864, 0.07264725863933563, 0.5549032092094421, 0.2240549921989441, -0.14456672966480255, -0.9532448649406433, -0.37506920099258423, -0.2451665997505188, -0.09252475202083588, 0.8740832209587097, -0.0641971081495285, 0.4549500346183777, 0.24373683333396912, 0.01475125178694725, 0.31219804286956787, -0.491234689950943, -0.097069650888443, -0.5694471597671509, 0.1499767154455185, -0.41391152143478394, -0.18912388384342194, -0.22936221957206726, 0.06025715172290802, 0.26780375838279724, -0.22605085372924805, -0.2631685733795166, -0.5777286291122437, -0.355488657951355, 0.1225699931383133, 0.24880924820899963, 0.43730947375297546, 0.11613006889820099, 0.48127949237823486, -0.22875134646892548, -0.7394468784332275, 0.7804131507873535, 0.23271793127059937, 0.07606673985719681, -0.048824142664670944, -0.06178119033575058, 0.5736154913902283, 0.23773863911628723, 0.033190153539180756, -0.31664690375328064, -0.7862331867218018, 0.045316316187381744, -0.3193800449371338, 0.6444895267486572, 0.13886061310768127, -0.2937868535518646, -0.0055898502469062805, 0.3614692687988281, -0.1926126480102539, -0.08620570600032806, -0.23899678885936737, -0.41129952669143677, 0.1242658793926239, 0.1671014130115509, 0.35034969449043274, 0.3945176899433136, -0.09506039321422577, 0.17038221657276154, 0.08184879273176193, 0.24371543526649475, 0.25960153341293335, 0.05302441492676735, -0.1057278960943222, -0.028096124529838562, 0.332489013671875, 0.038182832300662994, 0.28663063049316406, -0.4325328767299652, 0.2826286256313324, 0.2347407191991806};
    float embedding6[] = {-1.041235089302063, -0.21687623858451843, 0.1288924515247345, 1.1130307912826538, 0.8869999647140503, 2.0162394046783447, -0.44504305720329285, -1.144709825515747, -1.5842260122299194, -0.45235878229141235, 0.06454423815011978, -0.985165536403656, -0.6238227486610413, 1.8808400630950928, 0.5106055736541748, 0.37639862298965454, 1.823799967765808, -0.960643470287323, -0.9547262191772461, 0.9462190866470337, 0.38726672530174255, -0.5968350768089294, -0.06310197710990906, 0.10104744136333466, 0.2257244884967804, -0.5163144469261169, 0.6710682511329651, -0.18151479959487915, 0.5490350723266602, 0.6970794796943665, 1.2562775611877441, 0.43200257420539856, -1.0612518787384033, 1.0357780456542969, -0.04938092827796936, 1.6229296922683716, -1.661900520324707, -0.380233496427536, 0.36477741599082947, 1.6274538040161133, 1.5578759908676147, -0.5035871267318726, 0.5543830394744873, 2.182422637939453, 0.7619313597679138, -0.43645167350769043, 0.6944335699081421, -0.06471963226795197, 1.150460124015808, 0.07682856917381287, -1.1472479104995728, 0.20304057002067566, 0.08953683078289032, 0.5828089714050293, 0.42216843366622925, -0.4621719717979431, -1.4931284189224243, -0.6873064041137695, -0.5254234671592712, -0.041601501405239105, -0.9285162091255188, -0.5929263234138489, 0.5588128566741943, -0.474893182516098, -1.8482924699783325, 1.1117560863494873, -0.6853498220443726, 0.9464051127433777, 0.7439124584197998, 1.2391741275787354, -0.62166827917099, 1.4841997623443604, 0.9732398986816406, 0.27341318130493164, -0.5746681690216064, 0.925058901309967, 1.172385334968567, -0.24106143414974213, -0.7157064080238342, 2.8127472400665283, -1.810508370399475, 0.43634694814682007, 1.0621075630187988, 1.714586615562439, 1.9860174655914307, 1.6557804346084595, 0.6461197137832642, -1.191480040550232, -0.27031615376472473, -0.5677595138549805, 1.8599677085876465, 0.9493243098258972, -0.09132097661495209, 0.5680360794067383, 0.41300511360168457, 0.5689346194267273, 0.10546277463436127, 0.3265838325023651, -1.4465711116790771, 0.13386155664920807, -0.8872713446617126, 0.6666594743728638, -1.1609772443771362, 1.5193504095077515, 0.007149353623390198, -1.7055362462997437, 0.3404846489429474, 0.8990484476089478, -0.7638840079307556, -0.5476185083389282, -0.04188397899270058, 0.17648179829120636, 1.308480978012085, -0.33747559785842896, -0.8800963759422302, -0.2617781162261963, 1.1680445671081543, 0.9833597540855408, -0.4400431215763092, -2.1539435386657715, 1.7680031061172485, 0.9577364921569824, 2.1902365684509277, -2.332627296447754, -1.2013427019119263, -1.5699504613876343, -0.1764499992132187, 1.1378694772720337};

    kdtree_insere(&arv,aloca_reg(embedding1,"Amanda"));
    kdtree_insere(&arv,aloca_reg(embedding2,"Takashi"));
    kdtree_insere(&arv,aloca_reg(embedding3,"Mãe"));
    kdtree_insere(&arv,aloca_reg(embedding4,"Pai"));
    kdtree_insere(&arv,aloca_reg(embedding5,"Amanda2"));
    //kdtree_insere(&arv,aloca_reg(embedding6,"Edilson"));

    tnode * raiz = arv.raiz;

    printf("\n");
    treg  * atual = aloca_reg(embedding6,"Edilson");
    tnode * mais_proximo = kdtree_busca(&arv,atual);
    printf("mais prox: %s\n", ((treg *)mais_proximo->key)->id);
    
    memcpy(atual->emb, embedding4, 128*sizeof(float));
    mais_proximo = kdtree_busca(&arv,atual);
    printf("novo mais prox: %s\n", ((treg *)mais_proximo->key)->id);

    memcpy(atual->emb, embedding3, 128*sizeof(float));
    mais_proximo = kdtree_busca(&arv,atual);
    printf("novo mais prox: %s\n", ((treg *)mais_proximo->key)->id);

    free(atual);
    kdtree_destroi(&arv);
}


int main(void){
    test_constroi();
    test_busca();
    printf("SUCCESS!!\n");
    return EXIT_SUCCESS;
}